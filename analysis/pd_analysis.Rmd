---
title: "Prey Delivery Analysis"
author: "Eliza Stein"
date: "11/8/2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---


# Libraries

```{r}
library(tidyverse)
```



# Load data

```{r}

pdOriginal <- read.csv("~/final-project/data/pd_main.csv")


#rename the first column, which imported with a special character
names(pdOriginal)[1] <- "nest"


```



# Tidy data

Filter to only include males in B (Missouri) and C (Hayman)

```{r}

pdHayMiss <- pdOriginal %>%
  separate(col = nest, into = c("study_site", "territory"), sep = 1, remove = TRUE) %>%
  filter(study_site == "B" | study_site == "C", sex == "M")

```


Check structure of data

```{r}

str(pdHayMiss) #columns 't180' and 't225' are character classes

unique(pdHayMiss$t180) #at least one cell has an asterisk after the value
unique(pdHayMiss$t225) #same here

#remove asterisks
pdClean <- pdHayMiss %>%
  mutate(t180 = gsub("\\*", "", t180)) %>%
  mutate(t225 = gsub("\\*", "", t225))

#change these columns to integers
pdClean$t180 <- as.integer(pdClean$t180)
pdClean$t225 <- as.integer(pdClean$t225)


```


Get mean number of prey deliveries for each study site, by time interval

```{r}

#create independet dfs for Hayman and Missouri. (since the last observation for Hayman is at t240, we'll end both datasets there)
pdHay <- pdClean %>%
  filter(study_site == "C") %>%
  select(t15:t240)
pdMiss <- pdClean %>%
  filter(study_site =="B") %>%
  select(t15:t240)

#change column names to remove "t" in front of time interval
colnames(pdHay) <- c("15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240")
colnames(pdMiss) <- c("15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240")

#make new data frames with column means for each time interval 
meanHay <- data.frame(Hayman = colMeans(pdHay, na.rm = TRUE))
meanMiss <- data.frame(Missouri = colMeans(pdMiss, na.rm = TRUE))



#create new transposed df with means for Hayman and Missouri
wideMeanPD <- as.matrix(t(cbind(meanHay, meanMiss)))
wideMeanPD

```




Below is a data.frame of pds for Hayman and Missouri, which can be grouped by "study_site"

```{r}

#bind only time observations for each study site
bindHay <- cbind(study_site = "Hayman", pdHay)
bindMiss <- cbind(study_site = "Missouri", pdMiss)

pdHayMiss <- rbind(bindHay, bindMiss)

```



# Plot mean prey deliveries

Barplot:

```{r}

meanPlot <- barplot(
  wideMeanPD, 
  beside = TRUE, 
  legend.text = TRUE, 
  col = c("red", "blue"),
  ylim = c(0, 3),
  xlab = "Time After Sunset (minutes)",
  ylab = "Mean Prey Deliveries",
  main = "Mean Prey Deliveries Throughout Night"
)

```


# Calculate confidence intervals


Here's a start...

This seems to execute successfull for the pdHay$'15'
```{r}
#replicate mean of sampling 1000 times
vec <- pdHay[[1]]
new <- replicate(10000, mean(sample(vec, replace = TRUE), na.rm = TRUE))

#finds CI of 'new'
quantile(new, c(0.25, 0.975))

```

Now to write function:
```{r}

getCI <- function(df, n) {
  new <- replicate(1000, mean(
    sample(df[[n]], replace = TRUE), na.rm = TRUE)
    )
  sapply(
    df,
    new #I try applying 'new' as a function but it makes sense that it doesn't work because it's set to only run on df[[n]]
  )
}

getCI(pdHay, 1)


```


Eventually will append CIs to meanHay and meanMiss:
```{r}

longMeanPD <- data.frame(cbind(meanHay, meanMiss), time = seq(15, 240, by = 15))
longMeanPD
```


Playing with linear models:
```{r}
# linear model for Hayman PDs
m1 <- lm(longMeanPD$Hayman ~ longMeanPD$time)

plot(y = longMeanPD$Hayman, x = longMeanPD$time)
abline(m1)

# predict for Hayman PDs
predict(m1, longMeanPD, interval = 'confidence')
preds1 <- as.data.frame(predict(m1, longMeanPD, interval = 'confidence'))

# plot prediction model for Hayman
plot(y = longMeanPD$Hayman, x = longMeanPD$time, pch = 16)
points(y = preds1$fit, x = longMeanPD$time, pch = 16, col = 'red')
segments(y0 = preds1$lwr, y1 = preds1$upr, x0 = longMeanPD$time, col = 'red')


# below is start to Missouri
m2 <- lm(longMeanPD$Missouri ~ longMeanPD$time)

plot(y = longMeanPD$Missouri, x = longMeanPD$time)
abline(m2)

```

