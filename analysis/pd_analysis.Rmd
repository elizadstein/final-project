---
title: "Prey Delivery Analysis"
author: "Eliza Stein"
date: "11/8/2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Introduction

write intro here.

# Initialization

## Required Packages

```{r}
# Data manipulation and visualization
#install.packages("tidyverse")
library(tidyverse)

# Spatial data analysis
#install.packages("raster")
#install.packages("sf")
#install.packages("RColorBrewer")
#install.packages("rgdal")
#install.packages("ggmap")

library(sf)
library(raster)
library(RColorBrewer)
library(rgdal)
library(ggmap)

```

## Custom functions:

```{r}

#' getFrac
#' 
#' @param vec a vector
#' @param n_samp number of times to sample data
#'
#' @return upper and lower bootstrap confidence intervals
#' 
#'
#' @examples
#'    getCI(1:20, 1000)
#' @export

getCI <- function(vec, n_samp=10000) {
  smp <- replicate(n_samp, mean(sample(vec, replace = TRUE), na.rm = TRUE))
  CIs <-quantile(smp, c(0.025, 0.975), na.rm = T)
  return(CIs)
}

```


# Study Area

## Hayman Fire Scar

Load in fire scar polygon. Projected coordinate reference system: UTM Zone 13N. Extent:

```{r}

# Load Boundary
boundary_sf <- st_read("./final-project/analysis/images/hayman.shp")

# Get extent
st_bbox(boundary_sf)

#change hayman boundary class from `sf` to `spatial`?

```


Load in raster data:

```{r}

# Load raster image
severity <- raster("./final-project/analysis/images/burn_severity/burn_severity.adf")

#change boundary class from `sf` to `spatial`
boundary_sp <- as(boundary_sf, "Spatial")

#first crop raster by the bounding box of the perimeter .shp
severity_crop <- crop(severity, boundary_sp)

#then mask by actual polygon
severity_crop <- mask(severity_crop, boundary_sp)

# Convert to df
severity_df <- raster::as.data.frame(severity_crop, xy = TRUE)
# remove weird red hole in middle
severity_df$burn_severity[severity_df$burn_severity == 6] <- NA

# Plot
fire_colors <- rev(brewer.pal(n = 7, "RdYlGn")) %>%
  colorRampPalette()

severity_plot <- ggplot() +
  geom_raster(data = severity_df, aes(x = x, y = y, 
    fill = burn_severity)) +
  scale_fill_gradientn(name = "Burn Severity", colors = fire_colors(7), na.value = "white") +
  theme_void()


```


Severity with boundary: 

```{r}
#plot severity with boundary overlay
sev_bound_plot <- severity_plot + 
  geom_sf(data = boundary_sf, size = 1, color = "black", fill = NA) +
  coord_sf() +
  theme_void()

```

Add nest location data (n = 45):

```{r}
# Read in nest tree data
nest_dat <- read.csv("./data/nest_trees.csv")

# Plot nest trees over Hayman burn map
sev_bound_plot +
  geom_point(data = nest_dat, mapping = aes(x = x_coord, y = y_coord), color = "red") +
  ggtitle("Hayman Fire Nest Sites") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5))


```


Plot Hayman over CO basemap (maybe remove):
```{r}
# Get extent of Hayman from shapefile
st_bbox(boundary_sf)

co_basemap <- get_map(location=c(left = -46.18558, bottom = 43.156723, right = -49.08987, top = 43.524593), zoom=11, maptype = 'terrain-background', source = 'stamen')


plot(co_basemap)
```



# Load data

```{r}

setwd("C:/Users/eliza/Documents/final-project")
pdOriginal <- read.csv("./data/pd_main.csv")


#rename the first column, which imported with a special character
names(pdOriginal)[1] <- "nest"


```




## Clean up data


Filter to only include males in B (MGSA) and C (HFSA).

```{r}

pdHM <- pdOriginal %>%
  separate(col = nest, into = c("study_site", "territory"), sep = 1, remove = TRUE) %>%
  filter(study_site == "B" | study_site == "C", sex == "M")

```


Check structure of data.

```{r, structure}

#str(pdHM) #columns 't180' and 't225' are character classes, "nest_age" is character class

#unique(pdHM$t180) #at least one cell has an asterisk after the value
#unique(pdHM$t225) #same here
#unique(pdHM$nest_age) #"pred" and "" can be converted to NA

#remove asterisks
pdClean <- pdHM %>%
  mutate(t180 = gsub("\\*", "", t180)) %>%
  mutate(t225 = gsub("\\*", "", t225))


#change these columns to numeric
pdClean$t180 <- as.integer(pdClean$t180)
pdClean$t225 <- as.integer(pdClean$t225)
pdClean$nest_age <- as.integer(pdClean$nest_age) #warning here is ok--NAs are replacing "pred" and "" values


```



# Prey Deliveries Throughout Night

Data was separated by study site (HFSA vs. MGSA) and by incubation vs. nestling stage. Nestling period is defined as nest_age >= 22 days. If nest age was not indicated in original dataset, field notes were used to determine whether nest was in incubation (all eggs) or nestling (at least one nestling) stage. For these records, the following values were manually input: nest_age = 0 for incubation or nest_age = 100 for nestling, so that this data could be easily separated from known nest age.  If it was later determined that nest had been predated before observation, "pred" was entered. If the nest stage could not be determined, it was left blank."pred" and "" values were converted to NA earlier when this column was converted to numeric.

since the last observation for HFSA is at time = 240, we'll end both datasets there.

First, create data frame with PDs for whole dataset, then broken down by each study site and stage.

```{r, pd_indiv}

#create independet dfs for HFSA (nestling and incubation stage) and MGSA (nestling and incubation state). 

#select relevant columns, add column for stage, rename study sites, drop NAs
pdStage <- pdClean %>%
  select(study_site, nest_age, t15:t240) %>%
  mutate(
    stage =
      ifelse(nest_age < 22, "incubation", "nestling"),
    study_site =
      ifelse(study_site == "B", "MGSA", "HFSA")) %>%
  drop_na(stage)

#change column names to remove "t" in front of time interval
colnames(pdStage) <- c("study_site", "nest_age", "15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240", "stage")

#create independent dfs for each study site and stage
pdHFSA_inc <- pdStage %>%
  filter(study_site =="HFSA", stage == "incubation") %>%
  select('15':'240')

pdHFSA_nest <- pdStage %>% 
  filter(study_site =="HFSA", stage == "nestling") %>%
  select('15':'240')

pdMGSA_inc <- pdStage %>%
  filter(study_site =="MGSA", stage == "incubation") %>%
  select('15':'240')
         
pdMGSA_nest <- pdStage %>%
  filter(study_site =="MGSA", stage == "nestling") %>%
  select('15':'240')


```




## Mean PD tables

Four stand-alone data.frames, one for (incubation), one for HFSA (nestling), one for MGSA(incubation), and one for MGSA (nestling):

```{r}

meanHFSA_inc <- data.frame(
  time = as.numeric(colnames(pdHFSA_inc)),
  HGSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE))

meanHFSA_nest <- data.frame(
  time = as.numeric(colnames(pdHFSA_nest)),
  HGSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE))

meanMGSA_inc <- data.frame(
  time = as.numeric(colnames(pdMGSA_inc)),
  MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE))

meanMGSA_nest <- data.frame(
  time = as.numeric(colnames(pdMGSA_nest)),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE))

```


Two tables, one for nestling stage and one for incubation stage. This is just for visualization, not used in further analysis.

```{r eval=FALSE, include=FALSE}

#filtered this one to end at time = 180, because no observations exist for MGSA after that point
meanInc <- filter(
  data.frame(
    time = as.numeric(colnames(pdHFSA_inc)),
    HGSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE),
    MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE)),
  time <= 180
)

meanNest <-
  data.frame(
  time = as.numeric(colnames(pdHFSA_nest)),
  HGSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE)
)

```


One table showing mean PDs for all study sites and stages:
```{r}
meanAll <- data.frame(
  time = as.numeric(colnames(pdHFSA_inc)),
  HGSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE),
  HGSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE),
  MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE)
)

```




## Calculate confidence intervals

Write and apply function to obtain CIs.

```{r}



#now apply it across the columns of PD data
ciHFSA_inc <- apply(pdHFSA_inc, 2, FUN = getCI)
ciHFSA_nest <- apply(pdHFSA_nest, 2, FUN = getCI)
ciMGSA_inc <- apply(pdMGSA_inc, 2, FUN = getCI)
ciMGSA_nest <- apply(pdMGSA_nest, 2, FUN = getCI)
```


Add CIs to a data frame. Remove rows where time > 180 for ciInc because no data is available for MGSA after this time.

```{r}

ciInc <- filter(
  data.frame(
    study_area = c(rep("HFSA", nrow(meanHFSA_inc)), rep("MGSA", nrow(meanMGSA_inc))),
    mean = c(colMeans(pdHFSA_inc, na.rm = TRUE), colMeans(pdMGSA_inc, na.rm = TRUE)),
    ci_l = c(ciHFSA_inc[1,], ciMGSA_inc[1,]),
    ci_h = c(ciHFSA_inc[2,], ciMGSA_inc[2,]),
    time = c(as.numeric(rownames(meanHFSA_inc)), as.numeric(rownames(meanMGSA_inc))),
    stage = "Incubation"),
  time <= 180)


ciNest <- data.frame(
    study_area = c(rep("HFSA", nrow(meanHFSA_nest)), rep("MGSA", nrow(meanMGSA_nest))),
    mean = c(colMeans(pdHFSA_nest, na.rm = TRUE), colMeans(pdMGSA_nest, na.rm = TRUE)),
    ci_l = c(ciHFSA_nest[1,], ciMGSA_nest[1,]),
    ci_h = c(ciHFSA_nest[2,], ciMGSA_nest[2,]),
    time = c(as.numeric(rownames(meanHFSA_nest)), as.numeric(rownames(meanMGSA_nest))),
    stage = "Nestling")
    
ciAll <- rbind(ciInc, ciNest)

```



## Plot

Incubation:
```{r}

plotInc <- ggplot(data = ciInc) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Incubation", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```


Nestling:
```{r}

plotNest <- ggplot(data = ciNest) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Nestling", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```

Both:
```{r}

plotAll <- ggplot(data = ciAll) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Average Prey Deliveries Throughout Night", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_grid(~ stage)

```

Plot both as separate plots, side by side:
```{r}

grid.arrange(plotNest, plotInc)

```



## Prey Deliveries by Year

Going to create a similar graph but with years on the x-axis. I will sum values from time = 15 through time = 60 and only use this data from the first hour of each night.

```{r}


```

