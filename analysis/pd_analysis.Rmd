---
title: "Prey Delivery Analysis"
author: "Eliza Stein"
date: "11/8/2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
break down by nestling/incubation
for Hayman nestling and incubation: dot and whisker plot, if pd changes over years

# Libraries

```{r}

#install.packages("tidyverse")
library(tidyverse)

```



# Load data

```{r}

setwd("C:/Users/eliza/Documents/final-project")
pdOriginal <- read.csv("./data/pd_main.csv")


#rename the first column, which imported with a special character
names(pdOriginal)[1] <- "nest"


```




## Clean up data


Filter to only include males in B (Missouri) and C (Hayman)

```{r}

pdHM <- pdOriginal %>%
  separate(col = nest, into = c("study_site", "territory"), sep = 1, remove = TRUE) %>%
  filter(study_site == "B" | study_site == "C", sex == "M")

```


Check structure of data

```{r}

str(pdHM) #columns 't180' and 't225' are character classes

unique(pdHM$t180) #at least one cell has an asterisk after the value
unique(pdHM$t225) #same here

#remove asterisks
pdClean <- pdHM %>%
  mutate(t180 = gsub("\\*", "", t180)) %>%
  mutate(t225 = gsub("\\*", "", t225))

#change these columns to numeric
pdClean$t180 <- as.integer(pdClean$t180)
pdClean$t225 <- as.integer(pdClean$t225)


```



# Prey Deliveryies Throughout Night

Data was separated by study site and by incubation vs. nestling stage. Nestling period is defined as nest_age >= 22 days. If nest age was not indicated in original dataset, ES went back into field notes to determine whether nest was in incubation (all eggs) or nestling (at least one hatching) stage. For these records, ES manually input nest_age = 0 for incubation or nest_age = 100 for nestling, so that this data could be easily separated from known nest age.

Get mean number of prey deliveries for each study site, by time interval

```{r}

#create independet dfs for HFSA (nestling and incubation stage) and MGSA (nestling and incubation state). (since the last observation for Hayman is at t240, we'll end both datasets there)
pdIncH <- pdClean %>%
  filter(study_site == "C", ) %>%
  select(t15:t240)

pdNestH <- 


pdMGSA <- pdClean %>%
  filter(study_site =="B") %>%
  select(t15:t240)

#change column names to remove "t" in front of time interval
colnames(pdHFSA) <- c("15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240")
colnames(pdMGSA) <- c("15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240")
```




## Mean PD tables

Two stand-alone data.frames, one for HFSA and one for MGSA:

```{r}

meanHFSA <- data.frame(HGSA = colMeans(pdHFSA, na.rm = TRUE))

meanMGSA <- data.frame(MGSA = colMeans(pdMGSA, na.rm = TRUE))


```



Combined data.frame for HFSA and MGSA:

```{r}

meanPD <- data.frame(
  study_area = c(rep("HFSA", nrow(meanHFSA)), rep("MGSA", nrow(meanMGSA))),
  mean = c(colMeans(pdHFSA, na.rm = TRUE), colMeans(pdMGSA, na.rm = TRUE)),
  time = c(as.numeric(rownames(meanHFSA)), as.numeric(rownames(meanHFSA)))
  )

```



## Calculate confidence intervals


```{r}

#function to grab CIs from any vector
getCI <- function(vec, n_samp=10000) {
  smp <- replicate(n_samp, mean(sample(vec, replace = TRUE), na.rm = TRUE))
  CIs <-quantile(smp, c(0.025, 0.975), na.rm = T)
  return(CIs)
}

#now apply it across the columns of PD data
ciHFSA <- apply(pdHFSA, 2, FUN = getCI)
ciMGSA <- apply(pdMGSA, 2, FUN = getCI)
```


Add these to a data frame.

```{r}

ciMeanPD <- data.frame(
  study_area = c(rep("HFSA", nrow(meanHFSA)), rep("MGSA", nrow(meanMGSA))),
  mean = c(colMeans(pdHFSA, na.rm = TRUE), colMeans(pdMGSA, na.rm = TRUE)),
  ci_l = c(ciHFSA[1,], ciMGSA[1,]),
  ci_h = c(ciHFSA[2,], ciMGSA[2,]),
  time = c(as.numeric(rownames(meanHFSA)), as.numeric(rownames(meanHFSA)))
  )

```

Plot:
```{r}

ggplot(data = ciMeanPD) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Mean Prey Deliveries in HFSA and MGSA", color = "Study Area") +
  theme_minimal()

```
