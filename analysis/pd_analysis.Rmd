---
title: "Prey Delivery Analysis"
author: "Eliza Stein"
date: "11/5/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

##Start back up after line 62, need to remove rows with NA values

##Libraries

```{r}
library(tidyverse)
```



##Load data

```{r}

pdOriginal <- read.csv("~/final-project/data/pd_main.csv")

#correct class for two time intervals
as.integer(pdOriginal$'166', pdOriginal$'211')

#rename the first column, which imported with a special character
names(pdOriginal)[1] <- "nest"
```



##Tidy data

First, get each time interval into its own row by gathering the data. Also want to remove the "t" in front of each interval number.
```{r}

pdGathered <- pdOriginal %>%
  gather(
    t0:t526, key = "time_interval",
    value = num_pd,
    na.rm = TRUE) %>%
  separate(
    col = time_interval, into = c(NA, "time"), 
    sep = 1, remove = TRUE)

#change class of "time" to by numeric
pdGathered$time <- as.numeric(pdGathered$time)

```


Some values in "num_pd" are blank or contain asterisks. Remove asterisks and convert "num_pd" to integer.
```{r}

#remove asterisks
pdClean <- pdGathered %>%
  mutate(num_pd = gsub("\\*", "", num_pd))

#make num_pd an integer, which converts "" to NA
pdClean$num_pd <- as.integer(pdClean$num_pd)

#check number of blanks in pdClean vs pdGathered:
length(which(is.na(pdClean$num_pd))) #4752
length(which(pdGathered$num_pd=="")) #4750
#somehow there are 2 more NAs in pdClean after removing asterisks. If anything, pdClean is conservative count.

```



Select observations for males only. Also want to preserve only columns with relevant data.
```{r}

pdMales <- pdClean %>%
  filter(sex == "M") %>%
  select(nest, year, nest_age, sex, time, num_pd)

```

Remove NAs.
```{r}
#check which columns have NA values
colnames(pdMales)[ apply(pdMales, 2, anyNA) ] #"nest_age" "num_pd"

#remove NA observations. This removes rows where nest_age = NA, which is mostly due to observations of failed nests, and where num_pd = NA, which indicates that nest wasn't observed during that time interval.
pdNoNA <- na.omit(pdMales)

#some "nest_age" = -1, calculated backwards from estimated fledge date. Correct these values to = 1.
pdCorrected <- pdNoNA %>%
  mutate(nest_age = ifelse(nest_age == -1, 1, nest_age))
```


Only want observations from Hayman (nest starts with "C") and Missouri (nest starts with "B"). 

First, separate "study_site" from "nest," removing the territory ID and the original column. Then, filter for only Hayman ("C") and Missouri ("B")
```{r}

pdHayMissou <- pdCorrected %>%
  separate(col = nest, into = c("study_site", NA), sep = 1, remove = TRUE) %>%
  filter(study_site == "B" | study_site == "C")

```


##Plot mean number of prey deliveries for each time interval

Create variables
```{r}

meanHay <- pdHayMissou %>%
  filter(study_site == "C") %>%
  group_by(time) %>%
  summarise(meanPD = mean(num_pd))


meanMiss <- pdHayMissou %>%
  filter(study_site == "B") %>%
  group_by(time) %>%
  summarise(meanPD = mean(num_pd))


```

Create barplot...this didn't quite work, so not included.
```{r eval=FALSE, include=FALSE}

plotHay <- barplot(
  meanHay$meanPD,
  main = "Mean Prey Deliveries Throughout Night",
  xlab = "Time Interval",
  col = "red",
)
  legend("topright","Hayman", fill = "red")

#plotMiss <- barplot(meanMiss$meanPD)
  

```

Create geom_col of Hayman and Missouri
```{r}

colHay <- ggplot(data = meanHay, aes(x = time, y = meanPD, fill = "Hayman")) +
  geom_col() +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries") +
  scale_x_continuous(breaks = seq(0, 225, by=15))


colMiss <- ggplot(data = meanMiss, aes(x = time, y = meanPD, fill = "Missouri")) +
  geom_col() +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries") +
  scale_x_continuous(breaks = seq(0, 300, by=15))
  
```

Create combined graph of Hayman and Missouri
```{r}



```

