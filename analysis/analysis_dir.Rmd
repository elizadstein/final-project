---
output:
  pdf_document:
    citation_package: natbib
    keep_tex: false
    latex_engine: xelatex
title: "Nest Provisioning in a Fire Disturbed Landscape"
author: "Eliza Stein"
date: "11/8/2020"
bibliography: references.bib
csl: './apa.csl'
---

# Introduction

Fire plays an important role as a consistent disturbance in maintaining open stands of old-growth Ponderosa Pine (*Pinus ponderosa*) forests by helping to eliminate understory and limit fuel loads [@veblen2000climatic]. Before human intervention, Ponderosa Pine forests naturally underwent forest fires in 5-50 year intervals [@veblen2000climatic]. Over the past century, however, tree planting initiatives and increased implementation of fire suppression have led to increased density of stands [@griffis2001understory], making forest stands that are already drought stressed even more susceptible to high severity crown fires [@veblen2000climatic]. In 2002, a human-caused wildfire, the Hayman Fire, burned 138,000 acres of old-growth Ponderosa pine forests in Colorado's Pike National Forest [@graham2003hayman]. 

The Flammulated Owl (*Psiloscops flammeolus*) is a territorial, insectivorous, and nocturnal raptor native to montane forests in portions of the Rocky Mountains, Sierra Nevada Mountains, and the Occidental Mountains [@linkhart2013flammulated]. The diet of the owl primarily consists of moths native to these regions [@linkhart2013flammulated]. As a highly specialized secondary cavity nesting raptor, the Flammulated Owl is deemed an indicator species, meaning that the health of an ecosystem can be estimated based on the health of their population. Survival models have shown that Flammulated Owl survival in the HFSA is currently lower than survival in MGSA, suggesting that mortality, rather than emigration, explains most of the population declines following the Hayman Fire (Linkhart and Yanco, unpublished data).

Here, I examine one possible explanation for increased mortality in HFSA: prey availability. High severity burns dramatically alter vegetation structure, which in turn alters insect communities. Over time, insect communities within high intensity burn scars can crash, leaving avian predators without important food resources [@nappi2010effect]. If Flammulated Owls are adapting their behavior in response to changing prey availability, I would expect that the rate of prey deliveries to active nests would increase or decrease (increase if prey is lower quality, decrease if prey is more scarce or difficult to detect) [@zarybnicka2009tengmalm]. If Flammulated Owls are not adapting their behavior, this could mean that prey availability has either not changed or, more likely, that Flammulated Owls, which do not occupy landscapes prone to high severity burns, do not adapt their behavior in response to large-scale landscape changes.

# Initialization

All relative paths begin at the final-project repository root directory.

## Directories
```{r setup}
  library(knitr)
  opts_knit$set(root.dir=normalizePath('../final-project'))

```

## Required Packages

```{r}
# LaTex
#install.packages("tinytex")

# Data manipulation and visualization
install.packages("tidyverse", repos='http://cran.us.r-project.org')
install.packages("gridExtra", repos='http://cran.us.r-project.org')

```

```{r eval=FALSE, include=FALSE}
# Spatial data analysis
install.packages("sp", repos=c('http://R-Forge.R-project.org', 'http://cran.rstudio.com'))
install.packages("raster", repos='http://cran.us.r-project.org')
install.packages("rgdal", repos=c('http://R-Forge.R-project.org', 'http://cran.rstudio.com'))
install.packages("sf", repos=c('http://R-Forge.R-project.org', 'http://cran.rstudio.com'))
install.packages("RColorBrewer", repos='http://cran.us.r-project.org')
```

```{r}
# LaTex
#library(tinytex)
#tinytex::install_tinytex()

# Data manipulation and visualization
library(tidyverse)
library(gridExtra)

```

```{r eval=FALSE, include=FALSE}
# Spatial data analysis
library(sp)
library(raster)
library(rgdal)
library(sf)
library(RColorBrewer)
#library(ggmap)

```

## Working directory:

```{r eval=FALSE, include=FALSE}
library(knitr)
opts_knit$set(base.dir = './figures') # Change the base dir where to save figures
knit2html("./docs/report.Rmd", "./docs/report.html")

#setwd("~/final-project/")

```


## Custom functions:

```{r}

#' getCI
#' 
#' @param vec a vector
#' @param n_samp number of times to sample data
#'
#' @return upper and lower bootstrap confidence intervals
#' 
#'
#' @examples
#'    getCI(1:20, 2000)
#' @export

getCI <- function(vec, n_samp=1000) {
  smp <- replicate(n_samp, mean(sample(vec, replace = TRUE), na.rm = TRUE))
  CIs <-quantile(smp, c(0.025, 0.975), na.rm = T)
  return(CIs)
}

```


# Study Area

## Hayman Fire Study Area (HFSA)

Load in fire scar polygon. Projected coordinate reference system: UTM Zone 13N. 

```{r eval=FALSE, include=FALSE}

# Load Boundary
boundary_sf <- st_read("../analysis/images/hayman.shp")

# Get extent
ext <- st_bbox(boundary_sf)

```


Load in fire severity raster data:

```{r eval=FALSE, include=FALSE}

# Load raster image
severity <- raster("../analysis/images/burn_severity/burn_severity.adf")

# Change boundary shapefile class from `sf` to `spatial`
boundary_sp <- as(boundary_sf, "Spatial")

# Use fire boundary to crop fire severity raster
severity_crop <- raster::crop(severity, boundary_sp)

# Then mask by actual polygon
severity_crop <- raster::mask(severity_crop, boundary_sp)

# Convert to df
severity_df <- raster::as.data.frame(severity_crop, xy = TRUE)

# Remove red hole in middle
severity_df$burn_severity[severity_df$burn_severity == 6] <- NA

# Plot severity
fire_colors <- rev(brewer.pal(n = 7, "RdYlGn")) %>%
  colorRampPalette()

severity_plot <- ggplot() +
  geom_raster(data = severity_df, aes(x = x, y = y, 
    fill = burn_severity)) +
  scale_fill_gradientn(name = "Burn Severity", colors = fire_colors(7), na.value = "white") +
  theme_void()

# Plot severity with boundary overlay
sev_bound_plot <- severity_plot + 
  geom_sf(data = boundary_sf, size = 1, color = "black", fill = NA) +
  coord_sf() +
  theme_void()

```


Plot nest locations (n = 45) on Hayman Fire severity map:

```{r eval=FALSE, include=FALSE}
# Read in nest tree data
nest_dat <- read.csv("../data/nest_trees.csv")

# Plot nest trees over Hayman burn map
sev_bound_plot +
  geom_point(data = nest_dat, mapping = aes(x = x_coord, y = y_coord), color = "red") +
  ggtitle("Hayman Fire Nest Sites") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5))


```


Plot Hayman over CO basemap (maybe remove):

```{r eval=FALSE, include=FALSE}
# Get extent of Hayman from shapefile
st_bbox(boundary_sf)

co_basemap <- get_map(location=c(left = -46.18558, bottom = 43.156723, right = -49.08987, top = 43.524593), zoom=11, maptype = 'terrain-background', source = 'stamen')


plot(co_basemap)
```


# Prey Delivery Rates by Sex

Load prey delivery data.

```{r}


pdOriginal <- read.csv("./data/pd_main.csv")


#rename the first column, which imported with a special character
names(pdOriginal)[1] <- "nest"


```

Filter to only include M and F (remove unknown and total), separate "nest" column into "study_site' and territory.

```{r}

pdMF <- pdOriginal %>%
  separate(col = nest, into = c("study_site", "territory"), sep = 1, remove = TRUE) %>%
  filter(sex == "M" | sex == "F")

```

Check structure of data.

```{r}

pd_str <- str(pdMF)

unique(pdMF$t180) #at least one cell has an asterisk after the value
unique(pdMF$t225) #same here
unique(pdMF$nest_age) #"pred" and "" can be converted to NA

```

Fix structure.

```{r}
#remove asterisks
pdClean <- pdMF %>%
  mutate(t180 = gsub("\\*", "", t180)) %>%
  mutate(t225 = gsub("\\*", "", t225))


#change these columns to numeric
pdClean$t180 <- as.integer(pdClean$t180)
pdClean$t225 <- as.integer(pdClean$t225)
pdClean$nest_age <- as.integer(pdClean$nest_age) 

#warning here is ok--NAs are replacing "pred" and "" values

```


## Prey Deliveries Throughout Night

Data was separated by sex (M vs. F) and by incubation vs. nestling stage. Nestling period is defined as nest_age >= 22 days. If nest age was not indicated in original dataset, field notes were used to determine whether nest was in incubation (all eggs) or nestling (at least one nestling) stage. For these records, the following values were manually input: nest_age = 0 for incubation or nest_age = 100 for nestling, so that this data could be easily separated from known nest age.  If it was later determined that nest had been predated before observation, "pred" was entered. If the nest stage could not be determined, it was left blank."pred" and "" values were converted to NA earlier when this column was converted to numeric.

```{r}

# Create independent dfs for M (nestling and incubation stage) and F (nestling and incubation state). 

#select relevant columns, add column for stage, rename study sites, drop NAs
pdStage1 <- pdClean %>%
  dplyr::select(sex, nest_age, t15:t240) %>%
  mutate(
    stage =
      ifelse(nest_age < 22, "incubation", "nestling")) %>%
  drop_na(stage)

#change column names to remove "t" in front of time interval
colnames(pdStage1) <- c("sex", "nest_age", "15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240", "stage")

#create independent dfs for each study site and stage
pdM_inc <- pdStage1 %>%
  filter(sex =="M", stage == "incubation") %>%
  dplyr::select('15':'240')

pdM_nest <- pdStage1 %>% 
  filter(sex =="M", stage == "nestling") %>%
  dplyr::select('15':'240')

pdF_inc <- pdStage1 %>%
  filter(sex =="F", stage == "incubation") %>%
  dplyr::select('15':'240')
         
pdF_nest <- pdStage1 %>%
  filter(sex =="F", stage == "nestling") %>%
  dplyr::select('15':'240')

```

## Mean PD tables

Four stand-alone data.frames, one for M (incubation), one for M (nestling), one for F (incubation), and one for F (nestling):

```{r}

meanM_inc <- data.frame(
  time = as.numeric(colnames(pdM_inc)),
  M_incubation = colMeans(pdM_inc, na.rm = TRUE))

meanM_nest <- data.frame(
  time = as.numeric(colnames(pdM_nest)),
  M_nestling = colMeans(pdM_nest, na.rm = TRUE))

meanF_inc <- data.frame(
  time = as.numeric(colnames(pdF_inc)),
  F_incubation = colMeans(pdF_inc, na.rm = TRUE))

meanF_nest <- data.frame(
  time = as.numeric(colnames(pdF_nest)),
  F_nestling = colMeans(pdF_nest, na.rm = TRUE))

```


One table showing mean PDs for all study sites and stages:

```{r}
meanMF <- data.frame(
  time = as.numeric(colnames(pdM_inc)),
  M_incubation = colMeans(pdM_inc, na.rm = TRUE),
  M_nestling = colMeans(pdM_nest, na.rm = TRUE),
  F_incubation = colMeans(pdF_inc, na.rm = TRUE),
  F_nestling = colMeans(pdF_nest, na.rm = TRUE)
)

```




## Calculate confidence intervals

Write and apply function to obtain CIs.

```{r}

#now apply it across the columns of PD data
ciM_inc <- apply(pdM_inc, 2, FUN = getCI)
ciM_nest <- apply(pdM_nest, 2, FUN = getCI)
ciF_inc <- apply(pdF_inc, 2, FUN = getCI)
ciF_nest <- apply(pdF_nest, 2, FUN = getCI)
```


Add CIs to a data frame. Remove rows where time > 180 for ciInc because no data is available for MGSA after this time.

```{r}

ciInc_sex <- data.frame(
    sex = c(rep("M", nrow(meanM_inc)), rep("F", nrow(meanF_inc))),
    mean = c(colMeans(pdM_inc, na.rm = TRUE), colMeans(pdF_inc, na.rm = TRUE)),
    ci_l = c(ciM_inc[1,], ciF_inc[1,]),
    ci_h = c(ciM_inc[2,], ciF_inc[2,]),
    time = c(as.numeric(rownames(meanM_inc)), as.numeric(rownames(meanF_inc))),
    stage = "Incubation")


ciNest_sex <- data.frame(
    sex = c(rep("M", nrow(meanM_nest)), rep("F", nrow(meanF_nest))),
    mean = c(colMeans(pdM_nest, na.rm = TRUE), colMeans(pdF_nest, na.rm = TRUE)),
    ci_l = c(ciM_nest[1,], ciF_nest[1,]),
    ci_h = c(ciM_nest[2,], ciF_nest[2,]),
    time = c(as.numeric(rownames(meanM_nest)), as.numeric(rownames(meanF_nest))),
    stage = "Nestling")
    
ciAll_sex <- rbind(ciInc_sex, ciNest_sex)

```



## Plot

Incubation:
```{r}

plotInc_sex <- ggplot(data = ciInc_sex) +
  geom_point(aes(x = time, y = mean, color = sex, group = sex),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = sex, 
                    group = sex),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Incubation", color = "Sex") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```


Nestling:
```{r}

plotNest_sex <- ggplot(data = ciNest_sex) +
  geom_point(aes(x = time, y = mean, color = sex, group = sex),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = sex, 
                    group = sex),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Nestling", color = "Sex") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```


Plot both as separate plots, side by side:
```{r}  

pdf("analysis/figures/pds_by_sex.pdf")    # creates new pd file
grid.arrange(plotInc_sex, plotNest_sex)   # makes the actual plot
dev.off()     # closes the PDF file


```


## Test for Difference

Independent t-test for incubation stage. p = 5.163e-09
```{r}

t.test(meanF_inc$F_incubation, meanM_inc$M_incubation)

```

Independent t-test for nestling stage. p = 1.355e-08
```{r}

t.test(meanF_nest$F_nestling, meanM_nest$M_nestling)

```

# Prey Delivery Rates by Site


Filter pdMF to only include males in B (MGSA) and C (HFSA).

```{r}

pdHM <- pdClean %>%
  filter(study_site == "B" | study_site == "C", sex == "M")

```



## Visualize prey deliveries throughout night

Data was separated by study site (HFSA vs. MGSA) and by incubation vs. nestling stage. 

since the last observation for HFSA is at time = 240, we'll end both datasets there.

First, create data frame with PDs for whole dataset, then broken down by each study site and stage.

```{r, pd_indiv}

#create independet dfs for HFSA (nestling and incubation stage) and MGSA (nestling and incubation state). 

#select relevant columns, add column for stage, rename study sites, drop NAs
pdStage <- pdClean %>%
  dplyr::select(study_site, nest_age, t15:t240) %>%
  mutate(
    stage =
      ifelse(nest_age < 22, "incubation", "nestling"),
    study_site =
      ifelse(study_site == "B", "MGSA", "HFSA")) %>%
  drop_na(stage)

#change column names to remove "t" in front of time interval
colnames(pdStage) <- c("study_site", "nest_age", "15", "30", "45", "60", "75", "90", "105", "120", "135", "150", "165", "180", "195", "210", "225", "240", "stage")

#create independent dfs for each study site and stage
pdHFSA_inc <- pdStage %>%
  filter(study_site =="HFSA", stage == "incubation") %>%
  dplyr::select('15':'240')

pdHFSA_nest <- pdStage %>% 
  filter(study_site =="HFSA", stage == "nestling") %>%
  dplyr::select('15':'240')

pdMGSA_inc <- pdStage %>%
  filter(study_site =="MGSA", stage == "incubation") %>%
  dplyr::select('15':'240')
         
pdMGSA_nest <- pdStage %>%
  filter(study_site =="MGSA", stage == "nestling") %>%
  dplyr::select('15':'240')


```




## Mean PD tables

Four stand-alone data.frames, one for (incubation), one for HFSA (nestling), one for MGSA(incubation), and one for MGSA (nestling):

```{r}

meanHFSA_inc <- data.frame(
  time = as.numeric(colnames(pdHFSA_inc)),
  HFSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE))

meanHFSA_nest <- data.frame(
  time = as.numeric(colnames(pdHFSA_nest)),
  HFSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE))

meanMGSA_inc <- data.frame(
  time = as.numeric(colnames(pdMGSA_inc)),
  MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE))

meanMGSA_nest <- data.frame(
  time = as.numeric(colnames(pdMGSA_nest)),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE))

```


Two tables, one for nestling stage and one for incubation stage. This is just for visualization, not used in further analysis.

```{r eval=FALSE, include=FALSE}

#filtered this one to end at time = 180, because no observations exist for MGSA after that point
meanInc <- filter(
  data.frame(
    time = as.numeric(colnames(pdHFSA_inc)),
    HFSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE),
    MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE)),
  time <= 180
)

meanNest <-
  data.frame(
  time = as.numeric(colnames(pdHFSA_nest)),
  HFSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE)
)

```


One table showing mean PDs for all study sites and stages:
```{r}
meanAll <- data.frame(
  time = as.numeric(colnames(pdHFSA_inc)),
  HFSA_incubation = colMeans(pdHFSA_inc, na.rm = TRUE),
  HFSA_nestling = colMeans(pdHFSA_nest, na.rm = TRUE),
  MGSA_incubation = colMeans(pdMGSA_inc, na.rm = TRUE),
  MGSA_nestling = colMeans(pdMGSA_nest, na.rm = TRUE)
)

```




## Calculate confidence intervals

Write and apply function to obtain CIs.

```{r}

#now apply it across the columns of PD data
ciHFSA_inc <- apply(pdHFSA_inc, 2, FUN = getCI)
ciHFSA_nest <- apply(pdHFSA_nest, 2, FUN = getCI)
ciMGSA_inc <- apply(pdMGSA_inc, 2, FUN = getCI)
ciMGSA_nest <- apply(pdMGSA_nest, 2, FUN = getCI)
```


Add CIs to a data frame. Remove rows where time > 180 for ciInc because no data is available for MGSA after this time.

```{r}

ciInc <- filter(
  data.frame(
    study_area = c(rep("HFSA", nrow(meanHFSA_inc)), rep("MGSA", nrow(meanMGSA_inc))),
    mean = c(colMeans(pdHFSA_inc, na.rm = TRUE), colMeans(pdMGSA_inc, na.rm = TRUE)),
    ci_l = c(ciHFSA_inc[1,], ciMGSA_inc[1,]),
    ci_h = c(ciHFSA_inc[2,], ciMGSA_inc[2,]),
    time = c(as.numeric(rownames(meanHFSA_inc)), as.numeric(rownames(meanMGSA_inc))),
    stage = "Incubation"),
  time <= 180)


ciNest <- data.frame(
    study_area = c(rep("HFSA", nrow(meanHFSA_nest)), rep("MGSA", nrow(meanMGSA_nest))),
    mean = c(colMeans(pdHFSA_nest, na.rm = TRUE), colMeans(pdMGSA_nest, na.rm = TRUE)),
    ci_l = c(ciHFSA_nest[1,], ciMGSA_nest[1,]),
    ci_h = c(ciHFSA_nest[2,], ciMGSA_nest[2,]),
    time = c(as.numeric(rownames(meanHFSA_nest)), as.numeric(rownames(meanMGSA_nest))),
    stage = "Nestling")
    
ciAll <- rbind(ciInc, ciNest)

```



## Plot

Incubation:
```{r}

plotInc <- ggplot(data = ciInc) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Incubation", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```


Nestling:
```{r}

plotNest <- ggplot(data = ciNest) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Nestling", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```

Both:
```{r}

plotAll <- ggplot(data = ciAll) +
  geom_point(aes(x = time, y = mean, color = study_area, group = study_area),
             position = position_dodge(width=0.75)) +
  geom_errorbar(aes(x=time, ymax = ci_h, ymin=ci_l, color = study_area, 
                    group = study_area),
                position = position_dodge(width=0.75)) +
  labs(x = "Time After Sunset (minutes)", y = "Mean Prey Deliveries", 
       title = "Average Prey Deliveries Throughout Night", color = "Study Area") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_grid(~ stage)

```

Plot both as separate plots, side by side:
```{r}

pdf("analysis/figures/pds_by_site.pdf")    # creates new pd file
grid.arrange(grid.arrange(plotInc, plotNest))  # makes the actual plot
dev.off()     # closes the PDF file

```

## Test for Difference

Independent t-tests for incubation stage. p = 0.8786
```{r}

t.test(meanHFSA_inc$HFSA_incubation, meanMGSA_inc$MGSA_incubation)

```


Independent t-tests for nestling stage. p = 0.377

```{r}

t.test(meanHFSA_nest$HFSA_nestling, meanMGSA_nest$MGSA_nestling)

```
